<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="robots" content="index, follow" />
  <meta name="referrer" content="strict-origin-when-cross-origin" />

  <title>Videollamada | Ranquel Tech Lab</title>
  <link rel="stylesheet" href="./styles.css" />

  <!-- CSP (mantiene Daily en iframe) -->
  <meta http-equiv="Content-Security-Policy" content="
    default-src 'self';
    script-src 'self' 'unsafe-inline' https://www.googletagmanager.com https://www.google-analytics.com;
    connect-src 'self' https://www.google-analytics.com https://region1.google-analytics.com https://www.googletagmanager.com;
    img-src 'self' data: https://www.google-analytics.com https://www.googletagmanager.com;
    style-src 'self' 'unsafe-inline';
    frame-src 'self' https://*.daily.co;
    object-src 'none';
    frame-ancestors 'self';
    base-uri 'self';
    upgrade-insecure-requests" />

  <!-- GA4 (si ya lo usás en el sitio) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-JY9JDYZB52"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);} 
    gtag('js', new Date());
    gtag('config', 'G-JY9JDYZB52');
  </script>
</head>

<body>
  <header id="header" class="backdrop">
    <nav class="wrap" style="display:flex; justify-content:space-between; align-items:center;">
      <a href="/" class="logo neon">Ranquel Tech Lab</a>
      <a href="/" class="btn btn-ghost">Volver al inicio</a>
    </nav>
  </header>

  <main class="wrap section-padding" style="padding-top: 96px;">
    <div class="panel glow" style="padding: 20px;">
      <h1 class="neon" style="margin:0; font-size: clamp(26px,4vw,40px); font-weight: 800;">Videollamada</h1>
      <p style="margin-top: 8px; color: var(--text-muted);">
        Por seguridad, la sala se habilita con un <strong>link/código de acceso</strong>.
        Ese link te llega por email después de reservar.
      </p>

      <div class="booking-join" style="margin-top: 12px;">
        <label class="small-label" for="accessInput">Link / Código de acceso</label>
        <div class="booking-join-row">
          <input id="accessInput" class="input" type="text" placeholder="Pegá acá el link o el código que te llegó por email" />
          <button id="btnJoin" class="btn btn-accent glow" type="button">Entrar</button>
        </div>
        <p class="help">Si no tenés el link, pedinoslo por WhatsApp. Sin acceso no se puede entrar.</p>
      </div>

      <div id="status" class="muted" style="margin-top:10px;"></div>

      <div id="callWrap" class="daily-container" style="margin-top: 14px;">
        <div class="daily-placeholder">
          <strong>La videollamada se abre acá</strong>
          <p>Presioná “Entrar” para cargar la sala dentro de la web.</p>
        </div>
      </div>

      <div style="margin-top: 14px; display:flex; gap:10px; flex-wrap:wrap;">
        <a class="btn btn-ghost" href="/?view=reservas">Ir al turnero + videollamada</a>
        <a class="btn btn-ghost" target="_blank" rel="noopener noreferrer" href="https://calendar.app.google/LvSPMzEtUA8SKyRk6">Abrir agenda en nueva pestaña</a>
        <a class="btn btn-ghost" target="_blank" rel="noopener noreferrer" href="https://ranquel.daily.co/VideoLlamada">Abrir Daily (dueño)</a>
      </div>
    </div>
  </main>

  <script>
    function extractAccess(value) {
      const raw = (value || '').trim();
      if (!raw) return '';

      // Si pega URL completa
      try {
        if (/^https?:\/\//i.test(raw)) {
          const u = new URL(raw);
          const a = u.searchParams.get('access');
          if (a) return a;
        }
      } catch (_) {}

      // Si pega solo el access code
      if (raw.includes('.') && raw.length > 20) return raw;

      // Si pegó algo tipo "access=..."
      const m = raw.match(/access=([^&\s]+)/i);
      if (m && m[1]) return decodeURIComponent(m[1]);

      return raw;
    }

    async function joinWithAccess(access) {
      const status = document.getElementById('status');
      const wrap = document.getElementById('callWrap');
      status.textContent = 'Generando acceso seguro…';
      wrap.innerHTML = '<div class="muted">Cargando videollamada…</div>';

      const resp = await fetch(`/api/daily/token?access=${encodeURIComponent(access)}`, { cache: 'no-store' });
      const data = await resp.json().catch(() => ({}));

      if (!resp.ok || !data || !data.url) {
        const msg = (data && (data.details || data.error)) ? `${data.error || 'Error'}: ${data.details || ''}` : 'No se pudo generar el token.';
        status.textContent = '';
        wrap.innerHTML = `
          <div class="card" style="padding:16px">
            <strong>No se pudo habilitar la videollamada.</strong><br>
            <div class="muted">${msg}</div>
            <div class="muted" style="margin-top:8px">Tip: pegá el link exacto del email. Si el turno es para más tarde, probá más cerca del horario.</div>
          </div>
        `;
        return;
      }

      status.textContent = 'Acceso verificado. Conectando…';
      wrap.innerHTML = `
        <iframe
          title="Videollamada"
          src="${data.url}"
          allow="camera; microphone; fullscreen; speaker; display-capture"
          style="width: 100%; height: 640px; border: 0; border-radius: 12px;"
        ></iframe>
      `;
    }

    const params = new URLSearchParams(window.location.search);
    const accessFromUrl = params.get('access');

    const input = document.getElementById('accessInput');
    const btn = document.getElementById('btnJoin');

    if (accessFromUrl) {
      input.value = accessFromUrl;
      joinWithAccess(accessFromUrl);
    }

    btn.addEventListener('click', () => {
      const access = extractAccess(input.value);
      if (!access) {
        document.getElementById('status').textContent = 'Pegá el link o código de acceso.';
        return;
      }
      joinWithAccess(access);
    });

    input.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        e.preventDefault();
        btn.click();
      }
    });
  </script>
</body>
</html>
